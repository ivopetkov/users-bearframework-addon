/*
 * Users addon for Bear Framework
 * https://github.com/ivopetkov/users-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.users=ivoPetkov.bearFrameworkAddons.users||function(){var e=null,n=function(){o.dispatchEvent(function(e){if("function"==typeof Event)return new Event(e);var n=document.createEvent("Event");return n.initEvent(e,!1,!1),n}("change"))},t=function(e,n,t){void 0===t&&(t={}),clientPackages.get("modalWindows").then((function(o){o.open("ivopetkov-users-screen-window",{provider:e,id:n,data:t},{showErrors:!0})}))},o=new function(){var e={};this.addEventListener=function(n,t){void 0===e[n]&&(e[n]=[]),e[n].push(t)},this.removeEventListener=function(n,t){if(void 0!==e[n])for(var o=e[n],i=0;i<o.length;i++)if(o[i]===t)return void o.splice(i,1)},this.dispatchEvent=function(n){if(void 0===e[n.type])return!0;for(var t=e[n.type],o=0;o<t.length;o++)t[o].call(this,n);return!n.defaultPrevented}};Promise=window.Promise||function(e){var n=[],t=null;this.then=function(e){return n.push(e),this},this.catch=function(e){return null===t&&(t=e),this};var o=function(){for(var e in n)n[e].apply(null,arguments)},i=function(){null!==t&&t.apply(null,arguments)};window.setTimeout((function(){e(o,i)}),16)};var i=function(){var e=window.location.hash;if(0===e.indexOf("#/-u/")){history.replaceState("","",window.location.href.replace(e,""));var n=e.replace("#/-u/",""),o=n.split("/");t(o[0],"-hash-callback",{path:n.substring(o[0].length+1)})}},r=function(){return document.cookie.split(";").reduce((function(e,n){var t=n.split("=");try{e[t[0].trim()]=decodeURIComponent(t[1])}catch(n){e[t[0].trim()]=t[1]}return e}),{})};return document.addEventListener("readystatechange",()=>{i()}),"complete"===document.readyState&&i(),{currentUser:{exists:function(){return new Promise((function(t,o){null===e?clientPackages.get("serverRequests").then((function(i){i.send("ivopetkov-users-currentuser-exists").then((function(i){try{var r=JSON.parse(i)}catch(e){return void o()}void 0!==r.status&&"1"===r.status?(e="1"===r.exists,n(),t(e)):o()})).catch((function(){o()}))})):t(e)}))},openPreview:function(){clientPackages.get("modalWindows").then((function(e){e.open("ivopetkov-users-preview-window",{current:!0},{showErrors:!0})}))},getProfileDetails:function(e){return new Promise((function(n,t){clientPackages.get("serverRequests").then((function(o){o.send("ivopetkov-users-currentuser-details",{details:JSON.stringify(e)}).then((function(e){try{var o=JSON.parse(e)}catch(e){return void t()}void 0!==o.status&&"1"===o.status?n(o.details):n(null)})).catch((function(){t()}))}))}))},addEventListener:function(e,n){o.addEventListener(e,n)},removeEventListener:function(e,n){o.removeEventListener(e,n)}},login:function(t){return new Promise((function(o,i){var r=function(){i()};clientPackages.get("modalWindows").then((function(i){i.closeAll({expectShowLoading:!0}).then((function(){i.showLoading({closeOnEscKey:!1}).then((function(){clientPackages.get("serverRequests").then((function(c){var s={provider:t,location:window.location.toString()};c.send("ivopetkov-users-login",s).then((function(t){try{var c=JSON.parse(t)}catch(e){return void r()}void 0!==c.status&&"1"===c.status?(void 0!==c.exists&&(e=c.exists),void 0!==c.jsCode&&new Function(c.jsCode)(),void 0!==c.redirectURL?window.location=c.redirectURL:(void 0!==c.badgeHTML&&html5DOMDocument.insert(c.badgeHTML),i.hideLoading().then((function(){i.closeAll()})),n()),o()):r()})).catch(r)})).catch(r)})).catch(r)})).catch(r)})).catch(r)}))},logout:function(n){return void 0===n&&(n={}),void 0===n.reloadWindow&&(n.reloadWindow=!0),new Promise((function(t,o){var i=function(){e=!1;var t=r();for(var o in t)0===o.indexOf("ipu2-")&&(document.cookie=o+"=;path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT;domain="+location.host+";");n.reloadWindow&&window.location.reload()},c=function(){i(),t()};clientPackages.get("modalWindows").then((function(e){e.closeAll({expectShowLoading:!0}).then((function(){e.showLoading({closeOnEscKey:!1}).then((function(){clientPackages.get("serverRequests").then((function(e){e.send("ivopetkov-users-logout").then((function(e){try{var n=JSON.parse(e)}catch(e){return void c()}void 0!==n.status&&"1"===n.status?(i(),t()):c()})).catch(c)})).catch(c)})).catch(c)})).catch(c)})).catch(c)}))},openLogin:function(){clientPackages.get("modalWindows").then((function(e){e.open("ivopetkov-users-login-screen",{},{showErrors:!0})}))},openPreview:function(e,n){void 0!==e&&void 0!==n&&clientPackages.get("modalWindows").then((function(t){t.open("ivopetkov-users-preview-window",{provider:e,id:n},{showErrors:!0})}))},openProviderScreen:t,openProviderLogin:function(e){t(e,"login")},openProviderSignup:function(e){t(e,"signup")},_closeCurrentWindow:function(){"undefined"==typeof options&&(options={});var e={};return e.expectOpen=void 0!==options.expectOpen&&options.expectOpen,e.expectShowLoading=void 0!==options.expectShowLoading&&options.expectShowLoading,new Promise((function(n,t){clientPackages.get("modalWindows").then((function(t){t.closeCurrent(e),n()}))}))},_closeAllWindows:function(e){void 0===e&&(e={});var n={};return n.expectOpen=void 0!==e.expectOpen&&e.expectOpen,n.expectShowLoading=void 0!==e.expectShowLoading&&e.expectShowLoading,new Promise((function(e,t){clientPackages.get("modalWindows").then((function(o){o.closeAll(n).then(e).catch(t)}))}))},_showLoading:function(){return new Promise((function(e,n){clientPackages.get("modalWindows").then((function(t){t.showLoading().then(e).catch(n)}))}))},_updateBadge:function(e){var n;(n=document.querySelector(".ivopetkov-users-badge"))&&(n.parentNode.removeChild(n),1)&&html5DOMDocument.insert(e)},_dispatchProfileChange:function(){n()}}}();
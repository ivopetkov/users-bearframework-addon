/*
 * Users addon for Bear Framework
 * https://github.com/ivopetkov/users-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.users=ivoPetkov.bearFrameworkAddons.users||function(){var e=null,n=function(){i.dispatchEvent(function(e){if("function"==typeof Event)return new Event(e);var n=document.createEvent("Event");return n.initEvent(e,!1,!1),n}("change"))},t=function(e){html5DOMDocument.insert(e)},o=function(e,n){clientPackages.get("lightbox").then((function(t){var o=t.make();clientPackages.get("serverRequests").then((function(t){t.send("ivopetkov-users-screen-window",{provider:e,id:n}).then((function(e){var n=JSON.parse(e);void 0!==n.html&&o.open(n.html)}))}))}))},i=new function(){var e={};this.addEventListener=function(n,t){void 0===e[n]&&(e[n]=[]),e[n].push(t)},this.removeEventListener=function(n,t){if(void 0!==e[n])for(var o=e[n],i=0;i<o.length;i++)if(o[i]===t)return void o.splice(i,1)},this.dispatchEvent=function(n){if(void 0===e[n.type])return!0;for(var t=e[n.type],o=0;o<t.length;o++)t[o].call(this,n);return!n.defaultPrevented}};return Promise=window.Promise||function(e){var n=[],t=null;this.then=function(e){return n.push(e),this},this.catch=function(e){return null===t&&(t=e),this};var o=function(){for(var e in n)n[e].apply(null,arguments)},i=function(){null!==t&&t.apply(null,arguments)};window.setTimeout((function(){e(o,i)}),16)},{currentUser:{exists:function(){return new Promise((function(t,o){null===e?clientPackages.get("serverRequests").then((function(o){o.send("ivopetkov-users-currentuser-exists").then((function(o){var i=JSON.parse(o);"1"===i.status&&(e="1"===i.exists,n(),t(e))}))})):t(e)}))},addEventListener:function(e,n){i.addEventListener(e,n)},removeEventListener:function(e,n){i.removeEventListener(e,n)}},login:function(o){clientPackages.get("lightbox").then((function(i){var r=i.make();clientPackages.get("serverRequests").then((function(i){var s={provider:o,location:window.location.toString()};i.send("ivopetkov-users-login",s).then((function(o){var i=JSON.parse(o);"1"===i.status&&(e=!0,void 0!==i.jsCode&&new Function(i.jsCode)(),void 0!==i.redirectUrl?window.location=i.redirectUrl:(t(i.badgeHTML),r.close(),n()))}))}))}))},logout:function(){clientPackages.get("lightbox").then((function(e){e.make();clientPackages.get("serverRequests").then((function(e){e.send("ivopetkov-users-logout").then((function(e){"1"===JSON.parse(e).status&&window.location.reload()}))}))}))},openLogin:function(){clientPackages.get("lightbox").then((function(e){var n=e.make();clientPackages.get("serverRequests").then((function(e){e.send("ivopetkov-users-login-screen").then((function(e){var t=JSON.parse(e);void 0!==t.html&&n.open(t.html)}))}))}))},openPreview:function(e,n){void 0!==e&&void 0!==n&&clientPackages.get("lightbox").then((function(t){var o=t.make(),i={provider:e,id:n};clientPackages.get("serverRequests").then((function(e){e.send("ivopetkov-users-preview-window",i).then((function(e){var n=JSON.parse(e);void 0!==n.html&&o.open(n.html)})).catch((function(){o.close()}))}))}))},openProviderScreen:o,openProviderLogin:function(e){o(e,"login")},openProviderSignup:function(e){o(e,"signup")},_updateBadge:function(){clientPackages.get("serverRequests").then((function(e){e.send("ivopetkov-users-badge").then((function(e){var n,o=JSON.parse(e);void 0!==o.html&&((n=document.querySelector(".ivopetkov-users-badge"))&&n.parentNode.removeChild(n),""!==o.html&&t(o.html))}))}))}}}();